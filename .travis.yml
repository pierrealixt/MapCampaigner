# Common to all builds in the build matrixs
os: linux
language: python # This lets us use newer python versions from virtualenv
sudo: false
cache:
  apt: true
  pip: true
  directories:
    # commented out - we want to get fresh overpass file each time
    #- /tmp # cache any previously downloaded .osm files
  timeout: 1000
compiler: clang

python:
  - '3.6'
  - '3.5'
  - '3.4'

addons:
  postgresql: "9.6"
  apt:
    packages:
      - postgresql-9.6-postgis-2.3
      - postgis
      - osm2pgsql

env:
  global:
    - ON_TRAVIS=true
    - SECRET_KEY='tT\xd7\xb06\xf7\x9b\xff\x0fZL\xca\xca\x11\xefM\xacr\xfb\xdf\xca\x9b'
    - APP_SETTINGS=app_config.DevelopmentConfig
    - DATABASE_URL=postgresql://test_user:test_password@localhost/testing_db
    - TESTDATABASE_URL=postgresql://test_user:test_password@localhost/testing_db
    - LECHAT=bonjour

email:
  - pierrealix@kartoza.com

matrix:
  fast_finish: true
  include:
    - python: '3.6'
      env: TRAVIS_CONFIG=PYTHON3
    - python: '3.5'
      env: TRAVIS_CONFIG=PYTHON3
    - python: '3.4'
      env: TRAVIS_CONFIG=PYTHON3

  exclude:
    - python: '3.6'
    - python: '3.5'
    - python: '3.4'

git:
  depth: 30

before_install:

install:
  - pip install coveralls
  - pip install -r flask_project/requirements.txt

sudo: true

before_script:
  - psql -U postgres -c "create extension postgis"
  - psql -c "CREATE DATABASE testing_db;" -U postgres
  - psql -c "CREATE USER test_user WITH PASSWORD 'test_password';" -U postgres
  - psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE testing_db to test_user;"
  - psql -U postgres -c "ALTER USER test_user CREATEDB;"
  - psql -U postgres -c "create extension postgis" -d testing_db

script:
  - cd flask_project && make pep8
  - nosetests
  - echo "is echo working?"

deploy:
  - provider: elasticbeanstalk
    skip_cleanup: true
    access_key_id:
      secure: "BU2RXkQrTOyKCHzN0eLs4oA3PljSFhmzqkj1WY4ULRGIGFqtW7JFl7PKNvJR7KkpR5Y25wjSevG5TMq/2fl7UDWPbeP3jzItUoeF1+42Oeea1qkLGzUOg1zeRHZb4GQBuftzAa9CA2qnsO36ND8XcBaY8y5DDWU9HFJjLb4C1SpCGo92V14Ww7/Lni2buxMKMM6AlHR3ZZ4NNOet23zptd2duRir/g+fq7oOv/Jj8PFenh+c9fuEdHyFweD0zu7VPcnpKzia7gXC29/VK0huHRKKf054vl10KGRDYJyLyQQ7G+yJEOyA6p8OQw/MLT57l+Ow/+v8QNf7SHdB4g3NP4qerDaGU76hHGm8OuTOLi6yQhRP6vj2s92sTPxxkKyT0DdrSlNsP0qLseHVwZgDdvldhB3R+soMsEjVkNAdVHisqzZV+kHpWwpqAMV3SHUcqFFh9QZL2agvGzNIYg+ICg53mzr0c0vhbobjjJ9ax/X3837MnPNGfWUs1a0RODILt4pp3KZ3pj2JeqQwqLmPKzt23n3mkvuS+Ax6iyWLeygeBiqqOcKMYBoFexyDnalUmUg9WbpV+7+CmwmJrdTe+cwd9UkGLyx4wIDaNSQVtPslSJ7ijzlh6AoO2hZj6lIjYDjE+qkbrdFcGL0mh58J94S6gSvp3U3z5gyy/BQYCho="
    secret_access_key:
      secure: "1LfeSA3BlOSk6u80MZD7x7OR5qjmFQilS8z1HuvVyO4Vh4SWX1Pv4jxNKv24jb/5cONQ6ek4QTx71nW4sp0U55MXkiwCHpSXHqjtNOOkchfHBaHsO1GT2x+f8H7jNWAx9VMxuml4OWPaqNBLLD/4hufAg6szqO1RkYhiBAAc17eyqDrfqDPtbw+uggZ3ZA33jTr+/eFSmQZTxfNjwvDPpLhVdxc9pT3d3iPPZuIjx84uWMj/q7IKYDcTk8dykJ1n+IchvQDPX1E6Rn7L7oo5cuuxqLPin8LigbZaJN/I3xH1a+kxKC2whVjpflDY6gZUapgo7bYqUSL0Ly0NcukfeJxZ5X2M9pKBJR6pTn4IBPTi9kOQ5hxq0iBk/Vrklfa5NqbdntTJ67qFhIuEvw7TJLp8roXEm3QX17+J5MHv/1PZStG1NBGJSwyvtMikDhzJPdwsNy0SjTgh3Ceninb3fcjJp7OgnTc+Rvz+qFYvu8/5uGolBJ4VDABGpWP+TQBm4XfPChDv4eYYL/wXQCCSs6MCBe2EPRu2USJDGXoTIu4zqTHKoXKDsM+PIW9vqOcW99As/GF95+/dsZy1XyEJ8hrALNUD5HTmSQj2u7nq7ytUjWJMs1ZaITuBgVov56XboflIFFc0stuJctywIF/LgMvUCd2LBeDsJhlmNueMX+s="
    region: us-west-2
    app: "field-campaigner-eb"
    env: "field-campaigner-eb-dev"
    bucket_name: fieldcampaigner-eb-deployments
    zip_file: build.zip
    on:
      branch: aws-eb

  - provider: elasticbeanstalk
    skip_cleanup: true
    access_key_id:
      secure: "BU2RXkQrTOyKCHzN0eLs4oA3PljSFhmzqkj1WY4ULRGIGFqtW7JFl7PKNvJR7KkpR5Y25wjSevG5TMq/2fl7UDWPbeP3jzItUoeF1+42Oeea1qkLGzUOg1zeRHZb4GQBuftzAa9CA2qnsO36ND8XcBaY8y5DDWU9HFJjLb4C1SpCGo92V14Ww7/Lni2buxMKMM6AlHR3ZZ4NNOet23zptd2duRir/g+fq7oOv/Jj8PFenh+c9fuEdHyFweD0zu7VPcnpKzia7gXC29/VK0huHRKKf054vl10KGRDYJyLyQQ7G+yJEOyA6p8OQw/MLT57l+Ow/+v8QNf7SHdB4g3NP4qerDaGU76hHGm8OuTOLi6yQhRP6vj2s92sTPxxkKyT0DdrSlNsP0qLseHVwZgDdvldhB3R+soMsEjVkNAdVHisqzZV+kHpWwpqAMV3SHUcqFFh9QZL2agvGzNIYg+ICg53mzr0c0vhbobjjJ9ax/X3837MnPNGfWUs1a0RODILt4pp3KZ3pj2JeqQwqLmPKzt23n3mkvuS+Ax6iyWLeygeBiqqOcKMYBoFexyDnalUmUg9WbpV+7+CmwmJrdTe+cwd9UkGLyx4wIDaNSQVtPslSJ7ijzlh6AoO2hZj6lIjYDjE+qkbrdFcGL0mh58J94S6gSvp3U3z5gyy/BQYCho="
    secret_access_key:
      secure: "1LfeSA3BlOSk6u80MZD7x7OR5qjmFQilS8z1HuvVyO4Vh4SWX1Pv4jxNKv24jb/5cONQ6ek4QTx71nW4sp0U55MXkiwCHpSXHqjtNOOkchfHBaHsO1GT2x+f8H7jNWAx9VMxuml4OWPaqNBLLD/4hufAg6szqO1RkYhiBAAc17eyqDrfqDPtbw+uggZ3ZA33jTr+/eFSmQZTxfNjwvDPpLhVdxc9pT3d3iPPZuIjx84uWMj/q7IKYDcTk8dykJ1n+IchvQDPX1E6Rn7L7oo5cuuxqLPin8LigbZaJN/I3xH1a+kxKC2whVjpflDY6gZUapgo7bYqUSL0Ly0NcukfeJxZ5X2M9pKBJR6pTn4IBPTi9kOQ5hxq0iBk/Vrklfa5NqbdntTJ67qFhIuEvw7TJLp8roXEm3QX17+J5MHv/1PZStG1NBGJSwyvtMikDhzJPdwsNy0SjTgh3Ceninb3fcjJp7OgnTc+Rvz+qFYvu8/5uGolBJ4VDABGpWP+TQBm4XfPChDv4eYYL/wXQCCSs6MCBe2EPRu2USJDGXoTIu4zqTHKoXKDsM+PIW9vqOcW99As/GF95+/dsZy1XyEJ8hrALNUD5HTmSQj2u7nq7ytUjWJMs1ZaITuBgVov56XboflIFFc0stuJctywIF/LgMvUCd2LBeDsJhlmNueMX+s="
    region: us-west-2
    app: "field-campaigner-eb"
    env: "staging"
    bucket_name: fieldcampaigner-eb-deployments
    zip_file: build.zip
    on:
      branch: develop

after_deploy:
  - echo "done deploying"

after_script:
  - coveralls
  - echo "build done."
