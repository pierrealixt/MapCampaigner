<script src="{{ geopoints_url | safe }}"></script>

<div id="campaign-map-detail"></div>
<script type="text/javascript">

  var map = createMap();
  addLegend(map);
  setTitleLayer(map);
  setViewFromCampaign(map);
  renderMap(map);


  function createMap() {
    return L.map('campaign-map-detail').setView([0, 0], 1);
  }

  function addLegend(map) {
    var legend = L.control({position: 'bottomleft'});
    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML += '<span><b>Completeness</b></span><br/>';
      div.innerHTML += '<i style="background-color:#00840d"></i> <span>100%</span><br/>';
      div.innerHTML += '<i style="background-color:#faff00"></i> <span>75%</span><br/>';
      div.innerHTML += '<i style="background-color:#ffe500"></i> <span>50%</span><br/>';
      div.innerHTML += '<i style="background-color:#FD9A08"></i> <span>25%</span><br/>';
      div.innerHTML += '<i style="background-color:#ff0000"></i> <span>0%</span><br/>';
      return div;
    };
    legend.addTo(map);    
  }
    
  function setTitleLayer(map) {
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox.light'
    }).addTo(map);
  }

  function setViewFromCampaign(map) {
      
    geometry = {{ geometry }}
    campaign_layer = L.geoJSON(geometry);
    map.addLayer(campaign_layer);
    map.fitBounds(campaign_layer.getBounds());

    return map;
  }

  function renderMap(map) {
    var markers = L.markerClusterGroup({chunkedLoading: true});    
    var markerList = [];
    $.ajax({
        url: "{{ geopoints_url | safe }}",
        dataType: 'script',
        success: function(data) {
          for (var i = 0; i < geopoints_1.length; i++) {
            var point = geopoints_1[i];
            var popup = point[3];
            var marker = L.marker(L.latLng(point[0], point[1]));
            marker.bindPopup(popup);
            markerList.push(marker);
          }

          markers.addLayers(markerList);
          map.addLayer(markers);
          map.fitBounds(markers.getBounds());
      }
    });
  }

  function renderMapOld(map) {

    var markers = L.markerClusterGroup({chunkedLoading: true});

    var geojsonFilesCount = {{ feature_completeness['geojson_files_count']}};

    for (var i = 1; i <= geojsonFilesCount; i++) {
      var geojsonUrl = "{{ url | safe }}" + '/geojson_' + i + '.json';
      $.ajax({
        url: geojsonUrl,
        dataType: 'json',
        success: function(data) {
          var geojsonLayer = L.geoJSON(data, {
            pointToLayer: function (feature, latlng) {
              return L.circle(latlng, {
                radius: 5,
                fillColor: feature.properties.completeness_color,
                color: feature.properties.completeness_color,
                weight: 5,
                opacity: 1,
                fillOpacity: 0.8
                });
            },
            // onEachFeature: onEachFeature,
            style: function(feature) {
              return {color: feature.properties.completeness_color}
            }
          });
          markers.addLayer(geojsonLayer);
          map.addLayer(markers);
          map.fitBounds(markers.getBounds());
        }
      });
    }
  }

  function onEachFeature(feature, layer) {
    layer.bindPopup(feature.properties.popup);
  } 

</script>